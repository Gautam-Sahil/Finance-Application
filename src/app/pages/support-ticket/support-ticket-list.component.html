<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold heading">
      <i class="bi bi-ticket-perforated me-2"></i>Support Tickets
    </h2>
    <button class="btn btn-primary" (click)="createNewTicket()">
      <i class="bi bi-plus-circle"></i> New Ticket
    </button>
  </div>

  <div class="row mb-4 g-3">
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div><h6 class="card-title mb-0">Open</h6><h2 class="mt-2 mb-0">{{ openCount() }}</h2></div>
          <i class="bi bi-envelope-open display-4 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-primary text-white">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div><h6 class="card-title mb-0">In Progress</h6><h2 class="mt-2 mb-0">{{ inProgressCount() }}</h2></div>
          <i class="bi bi-arrow-repeat display-4 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-secondary text-white">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div><h6 class="card-title mb-0">Closed</h6><h2 class="mt-2 mb-0">{{ closedCount() }}</h2></div>
          <i class="bi bi-check-circle display-4 opacity-50"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4 g-2">
    <div class="col-md-3">
      <select class="form-select" [value]="statusFilter()" (change)="updateStatus($event)">
        <option value="">All Statuses</option>
        <option value="open">Open</option>
        <option value="in-progress">In Progress</option>
        <option value="closed">Closed</option>
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" [value]="priorityFilter()" (change)="updatePriority($event)">
        <option value="">All Priorities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Search tickets..." 
               [value]="searchTerm()" (input)="updateSearch($event)">
      </div>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100" (click)="loadTickets()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Subject</th>
          <th *ngIf="currentUser()?.role !== 'Customer'">Customer</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Last Updated</th>
          <th *ngIf="canAssign()">Assigned To</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (ticket of filteredTickets(); track ticket._id) {
          <tr style="cursor: pointer;" (click)="viewTicket(ticket._id)">
            <td><small class="text-muted">#{{ ticket._id.slice(-6) }}</small></td>
            <td class="fw-bold">{{ ticket.subject }}</td>
            <td *ngIf="currentUser()?.role !== 'Customer'">{{ ticket.userId?.fullName || 'N/A' }}</td>
            <td>
              <span class="badge" [ngClass]="getPriorityClass(ticket.priority)">
                {{ ticket.priority | uppercase }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusClass(ticket.status)">
                {{ ticket.status | titlecase }}
              </span>
            </td>
            <td>{{ ticket.updatedAt | date:'mediumDate' }}</td>
            <td *ngIf="canAssign()">{{ ticket.assignedTo?.fullName || '-' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" (click)="viewTicket(ticket._id); $event.stopPropagation()">
                View
              </button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <h5 class="mt-3">No tickets found</h5>
              <p class="text-muted">Adjust filters or create a new ticket.</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>