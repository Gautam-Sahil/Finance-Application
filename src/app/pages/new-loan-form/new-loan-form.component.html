<div class="container my-4 p-4 shadow rounded bg-light">
  <h2 class="mb-3 fw-bold text-center heading">
    <span><i class="bi bi-bank2"></i></span>
    Bank Application
    <span><i class="bi bi-bank2"></i></span>
  </h2>

  <form [formGroup]="loanForm" (ngSubmit)="submit()">

    <div class="mb-4">
      <div class="row">
        <div class="col-lg-12">
          <h3 class="mb-3 text-primary fw-bold heading">Personal Details</h3>

          <div class="row g-1 mt-1">
            <div class="col-md-6">
              <label for="fullName" class="form-label">Full Name :</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-person-lines-fill"></i></span>
                <input id="fullName" formControlName="fullName" class="form-control border-2 shadow-sm"
                  [class.is-invalid]="getControl('fullName')?.invalid && getControl('fullName')?.touched"
                  placeholder="Enter your full name" />
              </div>
              <div class="text-danger small" *ngIf="getControl('fullName')?.invalid && getControl('fullName')?.touched">
                Name is required (min 3 characters).
              </div>
            </div>
          </div>

          <div class="row g-1 mt-1">
            <div class="col-md-3">
              <label for="email" class="form-label">Email :</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-envelope-fill"></i></span>
                <input id="email" type="email" formControlName="email" class="form-control border-2"
                  [class.is-invalid]="getControl('email')?.invalid && getControl('email')?.touched"
                  placeholder="Enter your email address" />
              </div>
              <div class="text-danger small" *ngIf="getControl('email')?.invalid && getControl('email')?.touched">
                Valid email is required.
              </div>
            </div>

            <div class="col-md-3">
              <label for="mobileNumber" class="form-label">Phone Number :</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-telephone-fill"></i></span>
                <input id="mobileNumber" type="tel" formControlName="mobileNumber"
                  [class.is-invalid]="getControl('mobileNumber')?.invalid && getControl('mobileNumber')?.touched"
                  class="form-control border-2" placeholder="Enter your phone number" />
              </div>
              <div class="text-danger small" *ngIf="getControl('mobileNumber')?.invalid && getControl('mobileNumber')?.touched">
                10-digit number required.
              </div>
            </div>

            <div class="col-md-3">
              <label for="dateOfBirth" class="form-label">Date of Birth:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-calendar-date-fill"></i></span>
                <input id="dateOfBirth" type="date" formControlName="dateOfBirth"
                  [class.is-invalid]="getControl('dateOfBirth')?.invalid && getControl('dateOfBirth')?.touched"
                  class="form-control border-2" />
              </div>
            </div>
          </div>

          <div class="row g-1 mt-1">
            <div class="col-md-3">
              <label for="panCard" class="form-label">PAN Card:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-credit-card-fill"></i></span>
                <input id="panCard" type="text" maxlength="10" formControlName="panCard"
                  [class.is-invalid]="getControl('panCard')?.invalid && getControl('panCard')?.touched"
                  class="form-control border-2" placeholder="Enter your PAN Card number" />
              </div>
              <div class="text-danger small" *ngIf="getControl('panCard')?.invalid && getControl('panCard')?.touched">
                Invalid PAN (e.g. ABCDE1234F).
              </div>
            </div>

            <div class="col-md-3">
              <label for="salary" class="form-label">Annual Income:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-currency-dollar"></i></span>
                <input id="salary" type="number" formControlName="salary" class="form-control border-2"
                  [class.is-invalid]="getControl('salary')?.invalid && getControl('salary')?.touched"
                  placeholder="Enter your annual income" />
              </div>
            </div>

            <div class="col-md-3">
              <label for="employmentStatus" class="form-label">Employment Status:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-briefcase-fill"></i></span>
                <select id="employmentStatus" formControlName="employmentStatus" class="form-control border-2"
                  [class.is-invalid]="getControl('employmentStatus')?.invalid && getControl('employmentStatus')?.touched">
                  <option value="" disabled>Select your employment status</option>
                  <option value="employed">Employed</option>
                  <option value="unemployed">Unemployed</option>
                  <option value="freelancer">Freelancer</option>
                  <option value="student">Student</option>
                </select>
              </div>
            </div>
          </div>

          <div class="row g-1 mt-1">
            

            <div class="col-md-4">
              <label for="creditScore" class="form-label">Credit Score:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-credit-card-fill"></i></span>
                <input type="number" id="creditScore" formControlName="creditScore" class="form-control border-2"
                  [class.is-invalid]="getControl('creditScore')?.invalid && getControl('creditScore')?.touched"
                  placeholder="Enter your credit score" />
              </div>
              <div class="text-danger small" *ngIf="getControl('creditScore')?.invalid && getControl('creditScore')?.touched">
                Must be between 300 and 900.
              </div>
            </div>

            <div class="col-md-4">
              <label for="assets" class="form-label">Assets:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-archive-fill"></i></span>
                <textarea id="assets" formControlName="assets" class="form-control border-2"
                  [class.is-invalid]="getControl('assets')?.invalid && getControl('assets')?.touched"
                  placeholder="Describe your assets" rows="1"></textarea>
              </div>
            </div>
          </div>

          <hr>
          <h5 class="mt-4 text-primary fw-bold heading">Address Details</h5>
          <div class="row mt-2 pt-2">
            <div class="col-md-4">
              <label for="city" class="form-label">City:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-geo-alt-fill"></i></span>
                <input type="text" id="city" formControlName="city" class="form-control border-2"
                  [class.is-invalid]="getControl('city')?.invalid && getControl('city')?.touched" />
              </div>
            </div>

            <div class="col-md-4">
              <label for="state" class="form-label">State:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-geo-alt-fill"></i></span>
                <input type="text" id="state" formControlName="state" class="form-control border-2"
                  [class.is-invalid]="getControl('state')?.invalid && getControl('state')?.touched" />
              </div>
            </div>

            <div class="col-md-4">
              <label for="zipCode" class="form-label">Zip Code:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-geo-alt-fill"></i></span>
                <input type="text" id="zipCode" formControlName="zipCode" class="form-control border-2"
                  [class.is-invalid]="getControl('zipCode')?.invalid && getControl('zipCode')?.touched" />
              </div>
            </div>

            <div class="col-md-6 mt-2">
              <label for="address" class="form-label">Address:</label>
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light"><i class="bi bi-house-door-fill"></i></span>
                <textarea id="address" formControlName="address" class="form-control border-2"
                  [class.is-invalid]="getControl('address')?.invalid && getControl('address')?.touched"
                  placeholder="Enter your address" rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <div class="mb-4">
      <div class="row g-3">
        <div class="col-lg-7">
          <h4>Loan Details</h4>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Sr No</th>
                <th>Bank Name</th>
                <th>Loan Amount</th>
                <th>EMI</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody formArrayName="loans">
              <tr *ngFor="let loan of loans.controls; let i = index" [formGroupName]="i">
                <td>{{ i + 1 }}</td>
                <td>{{ loan.get('bankName')?.value }}</td>
                <td>{{ loan.get('loanAmount')?.value | number }}</td>
                <td>{{ loan.get('emi')?.value | number }}</td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm" (click)="removeLoan(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col-lg-5">
          <h5>Add Loan Details</h5>
          <div class="row g-2">
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Bank Name" #bankName />
            </div>
            <div class="col-md-4">
              <input type="number" class="form-control" placeholder="Loan Amount" #loanAmount />
            </div>
            <div class="col-md-4">
              <input type="number" class="form-control" placeholder="EMI" #emi />
            </div>
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-primary" (click)="addLoan(bankName, loanAmount, emi)">Add Loan</button>
          </div>
        </div>
      </div>

    </div>

    <!-- ========== DOCUMENTS SECTION (for all roles) ========== -->
  <!-- ========== DOCUMENTS SECTION ========== -->
    <div class="row mt-4">
      <div class="col-12">
        <h4 class="text-primary fw-bold heading">
          <i class="bi bi-file-earmark-text"></i> Supporting Documents
        </h4>
        <div class="card shadow-sm">
          <div class="card-body">
            <!-- ðŸ”¸ NEW APPLICATION: Multi-file select + auto-upload -->
            <div *ngIf="!applicationId" class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label fw-semibold">Select Files (will be uploaded on Save)</label>
                <div class="input-group">
                  <input 
                    type="file" 
                    class="form-control" 
                    multiple
                    (change)="onFilesSelected($event)">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-files"></i>
                  </span>
                </div>
              </div>
              <!-- Preview selected files -->
              <div class="col-12 mt-2" *ngIf="selectedFiles.length">
                <div class="d-flex flex-wrap gap-2">
                  <span *ngFor="let file of selectedFiles; let i = index" 
                        class="badge bg-light text-dark border d-flex align-items-center gap-1">
                    <i class="bi bi-file-earmark"></i> {{ file.name }}
                    <i class="bi bi-x-circle-fill text-danger" style="cursor: pointer;" 
                       (click)="removeSelectedFile(i)"></i>
                  </span>
                </div>
              </div>
            </div>

            <!-- ðŸ”¸ EXISTING APPLICATION: Manual upload button -->
            <div *ngIf="applicationId" class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Upload New Document</label>
                <div class="input-group">
                  <input type="file" class="form-control" #manualFileInput (change)="uploadManual(manualFileInput)">
                  <button class="btn btn-dark" type="button" (click)="uploadManual(manualFileInput)" [disabled]="!canUpload()">
                    <i class="bi bi-upload"></i> Upload
                  </button>
                </div>
                <small class="text-muted" *ngIf="!canUpload()">Only pending applications can be modified</small>
              </div>
            </div>

            <!-- Document List Table (same for both) -->
            <div class="mt-3" *ngIf="documents.length > 0">
              <h6 class="fw-bold">Uploaded Documents</h6>
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>File Name</th>
                      <th>Uploaded On</th>
                      <th>Status</th>
                      <th *ngIf="isBankerOrAdmin">Verification</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let doc of documents; let i = index">
                      <td>{{ doc.fileName }}</td>
                      <td>{{ doc.uploadedAt | date:'medium' }}</td>
                      <td>
                        <span class="badge" [ngClass]="doc.isVerified ? 'bg-success' : 'bg-warning text-dark'">
                          <i class="bi" [ngClass]="doc.isVerified ? 'bi-check-circle' : 'bi-clock-history'"></i>
                          {{ doc.isVerified ? 'Verified' : 'Pending' }}
                        </span>
                      </td>
                      <td *ngIf="isBankerOrAdmin">
                        <div class="form-check form-switch" *ngIf="!doc.isVerified">
                          <input class="form-check-input" type="checkbox" (click)="verifyDocument(i)">
                          <label class="form-check-label small">Mark Verified</label>
                        </div>
                        <span *ngIf="doc.isVerified" class="text-success small">
                          <i class="bi bi-check-circle"></i> Verified by {{ doc.verifiedBy?.fullName || 'Banker' }}
                          <br><small>{{ doc.verifiedAt | date:'short' }}</small>
                        </span>
                      </td>
                      <td>
                        <a [href]="'http://localhost:3000/' + doc.filePath" target="_blank" 
                           class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-eye"></i> View
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="documents.length === 0 && applicationId" class="text-muted small">
              No documents uploaded yet.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== APPROVAL WORKFLOW â€“ Banker/Admin only ========== -->
    <div class="row mt-4" *ngIf="isBankerOrAdmin && applicationId">
      <div class="col-12">
        <h4 class="text-primary fw-bold heading">
          <i class="bi bi-check2-circle"></i> Loan Review
        </h4>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Current Status</label>
                <div>
                  <span class="badge fs-6 p-2" [ngClass]="statusBadgeClass(loanForm.get('applicationStatus')?.value)">
                    <i [ngClass]="statusIconClass(loanForm.get('applicationStatus')?.value)"></i>
                    {{ loanForm.get('applicationStatus')?.value | uppercase }}
                  </span>
                </div>
              </div>
              <div class="col-md-8" *ngIf="loanForm.get('applicationStatus')?.value === 'pending'">
  <div class="d-flex gap-2 justify-content-end">
    
    <button type="button" class="btn btn-success" (click)="openApprovalModal()">
      <i class="bi bi-check-circle"></i> Approve
    </button>
    
    <button type="button" class="btn btn-danger" (click)="openRejectionModal()">
      <i class="bi bi-x-circle"></i> Reject
    </button>
    
    <button type="button" class="btn btn-warning" (click)="requestRevision()">
      <i class="bi bi-arrow-counterclockwise"></i> Request Revision
    </button>

  </div>
</div>
              <div class="col-md-8" *ngIf="loanForm.get('applicationStatus')?.value !== 'pending'">
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle"></i> 
                  This application was {{ loanForm.get('applicationStatus')?.value }} 
                  <span *ngIf="reviewHistory.length">on {{ reviewHistory[reviewHistory.length-1].date | date:'medium' }}</span>.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== REVIEW HISTORY (visible to all) ========== -->
    <div class="row mt-4" *ngIf="applicationId">
      <div class="col-12">
        <h4 class="text-primary fw-bold heading">
          <i class="bi bi-clock-history"></i> Activity Timeline
        </h4>
        <div class="card shadow-sm">
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            <ul class="timeline" *ngIf="reviewHistory.length">
              <li *ngFor="let event of reviewHistory" class="timeline-item pb-3">
                <span class="timeline-icon" [ngClass]="event.action"></span>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between">
                    <h6 class="fw-bold mb-0">
                      <i [ngClass]="timelineIcon(event.action)"></i> 
                      {{ event.action | titlecase }}
                    </h6>
                    <small class="text-muted">{{ event.date | date:'medium' }}</small>
                  </div>
                  <p class="mb-0" *ngIf="event.comment">{{ event.comment }}</p>
                  <small class="text-muted">by {{ event.reviewer?.fullName || event.reviewer?.username || 'System' }}</small>
                </div>
              </li>
            </ul>
            <div *ngIf="!reviewHistory.length" class="text-muted text-center">
              No activity recorded yet.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== ACTION BUTTONS ========== -->
    <div class="d-flex justify-content-center gap-2 mt-3">
      <button *ngIf="!applicationId" type="submit" class="btn text-white" 
              style="background: linear-gradient(to right, #00c6ff, #0072ff);"
              [disabled]="isUploading">
        <i class="bi bi-save"></i> {{ isUploading ? 'Saving...' : 'Save Application' }}
      </button>
      <button *ngIf="applicationId" type="submit" class="btn text-white"
              style="background: linear-gradient(to right, #11998e, #38ef7d);">
        <i class="bi bi-pencil-square"></i> Update
      </button>
      <button *ngIf="applicationId" type="button" (click)="onDelete()" class="btn text-white"
              style="background: linear-gradient(to right, #ff5f6d, #ffc371);">
        <i class="bi bi-trash"></i> Delete
      </button>
    </div>
  </form>
</div>

<!-- ========== MODALS for Approval/Rejection ========== -->
<!-- Approve Modal -->
<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-check-circle"></i> Approve Loan</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Remarks (optional)</label>
        <textarea class="form-control" rows="3" 
                  [(ngModel)]="approvalRemarks" 
                  [ngModelOptions]="{standalone: true}"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" (click)="approveApplication()">
          Confirm Approval
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-x-circle"></i> Reject Loan</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Rejection Reason <span class="text-danger">*</span></label>
        <textarea class="form-control" rows="3" 
                  [(ngModel)]="rejectionReason" 
                  [ngModelOptions]="{standalone: true}"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="rejectApplication()">Confirm Rejection</button>
      </div>
    </div>
  </div>
</div> 
