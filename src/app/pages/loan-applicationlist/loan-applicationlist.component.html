<div class="container my-4 p-4 shadow rounded bg-light">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold heading m-0">
      <span><i class="bi bi-bank2 me-2"></i></span>
      Loan Applications
      <span class="badge bg-secondary ms-2">{{ totalItems }} total</span>
    </h2>
    <button class="btn btn-outline-success" (click)="exportToExcel()">
      <i class="bi bi-file-earmark-excel"></i> Export
    </button>
  </div>

  <!-- FILTER ROW -->
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-md-4">
      <label class="form-label fw-semibold">üîç Search</label>
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input
          type="text"
          class="form-control"
          placeholder="Name, email, PAN..."
          [(ngModel)]="search"
          (input)="onSearchChange()"
        />
        @if (search) {
          <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()">
            <i class="bi bi-x"></i>
          </button>
        }
      </div>
    </div>

    <div class="col-md-2">
      <label class="form-label fw-semibold">üìå Status</label>
      <select class="form-select" [(ngModel)]="status" (change)="loadApplications()">
        <option value="">All</option>
        <option value="pending">‚è≥ Pending</option>
        <option value="approved">‚úÖ Approved</option>
        <option value="rejected">‚ùå Rejected</option>
        <option value="done">üéâ Done</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label fw-semibold">üìã Per page</label>
      <select class="form-select" [(ngModel)]="limit" (change)="resetPagination()">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
    </div>

    <div class="col-md-2 d-flex align-items-center">
      <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
        <i class="bi bi-arrow-counterclockwise"></i> Reset
      </button>
    </div>
  </div>

  <!-- LOADING SPINNER -->
  @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Fetching applications...</p>
    </div>
  } @else {
    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Applicant</th>
            <th>Contact</th>
            <th>PAN / DOB</th>
            <th>Financial</th>
            <th>Employment</th>
            <th>Status</th>
            <th>Credit Score</th>
            <th>Assets</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (item of applicationList; track item._id; let i = $index) {
            <tr>
              <td class="text-muted">{{ (page - 1) * limit + i + 1 }}</td>
              <td>
                <strong>{{ item.fullName }}</strong>
                @if (item.email) {
                  <br><small class="text-muted">{{ item.email }}</small>
                }
              </td>
              <td>
                <i class="bi bi-telephone me-1"></i>{{ item.mobileNumber }}
                @if (item.address) {
                  <br><small class="text-muted">{{ item.city }}, {{ item.state }}</small>
                }
              </td>
              <td>
                <span class="badge bg-light text-dark border">{{ item.panCard }}</span>
                @if (item.dateOfBirth) {
                  <br><small>{{ item.dateOfBirth | date:'dd/MM/yyyy' }}</small>
                }
              </td>
              <td>
                <span class="fw-semibold">{{ item.salary | currency:'INR' }}</span>
                @if (item.loans?.length) {
                  <br><small class="text-warning">{{ item.loans.length }} existing loan(s)</small>
                }
              </td>
              <td>
                <span class="badge bg-secondary">{{ item.employmentStatus || 'N/A' }}</span>
              </td>
              <td>
                <span class="badge" [ngClass]="statusBadgeClass(item.applicationStatus)">
                  <i [ngClass]="statusIconClass(item.applicationStatus)"></i>
                  {{ item.applicationStatus | uppercase }}
                </span>
              </td>
              <td>
                <span [ngClass]="creditScoreClass(item.creditScore)">
                  {{ item.creditScore || '‚Äî' }}
                </span>
              </td>
              <td>
                <span class="badge bg-light text-dark border">{{ item.assets || '‚Äî' }}</span>
              </td>
              <td class="text-center">
                <div class="d-flex justify-content-center gap-1">
                  <!-- View Button -->
                  <button class="btn btn-sm btn-outline-info" (click)="viewDetails(item)" title="View details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <!-- Edit Button -->
                  <button class="btn btn-sm btn-outline-primary" (click)="onEdit(item._id)" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <!-- Delete Button -->
                  <button class="btn btn-sm btn-outline-danger" (click)="deleteApplication(item._id)" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="10" class="text-center py-5">
                <i class="bi bi-folder-x display-4 text-muted"></i>
                <h5 class="mt-3">No loan applications found</h5>
                @if (search || status) {
                  <p class="text-muted">Try adjusting your search or filter</p>
                  <button class="btn btn-sm btn-outline-primary" (click)="resetFilters()">
                    Clear filters
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- PAGINATION -->
    @if (totalPages > 1) {
      <div class="d-flex flex-wrap justify-content-between align-items-center mt-4">
        <div class="text-muted small">
          Showing {{ (page - 1) * limit + 1 }} ‚Äì 
          {{ page * limit > totalItems ? totalItems : page * limit }}
          of {{ totalItems }} entries
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <!-- First & Previous -->
            <li class="page-item" [class.disabled]="page === 1">
              <button class="page-link" (click)="changePage(1)" title="First">
                <i class="bi bi-chevron-double-left"></i>
              </button>
            </li>
            <li class="page-item" [class.disabled]="page === 1">
              <button class="page-link" (click)="changePage(page - 1)" title="Previous">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>

            <!-- Page Numbers -->
            @for (p of visiblePages; track p) {
              <li class="page-item" [class.active]="p === page">
                <button class="page-link" (click)="changePage(p)">{{ p }}</button>
              </li>
            }

            <!-- Next & Last -->
            <li class="page-item" [class.disabled]="page === totalPages">
              <button class="page-link" (click)="changePage(page + 1)" title="Next">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
            <li class="page-item" [class.disabled]="page === totalPages">
              <button class="page-link" (click)="changePage(totalPages)" title="Last">
                <i class="bi bi-chevron-double-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    }
  }
</div>

<!-- ========== DETAIL MODAL ========== -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" style="margin-top: 50px;">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-file-text me-2"></i> Loan Application Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        @if (selectedApplication) {
          <div class="row g-3">
            <!-- Personal Info -->
            <div class="col-md-6">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light fw-bold">üë§ Personal Information</div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr><th style="width: 40%;">Full Name</th><td>{{ selectedApplication.fullName }}</td></tr>
                    <tr><th>Email</th><td>{{ selectedApplication.email }}</td></tr>
                    <tr><th>Mobile</th><td>{{ selectedApplication.mobileNumber }}</td></tr>
                    <tr><th>Date of Birth</th><td>{{ selectedApplication.dateOfBirth | date:'dd MMM yyyy' }}</td></tr>
                    <tr><th>PAN Card</th><td><span class="badge bg-light border">{{ selectedApplication.panCard }}</span></td></tr>
                  </table>
                </div>
              </div>
            </div>
            <!-- Financial Info -->
            <div class="col-md-6">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light fw-bold">üí∞ Financial Information</div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr><th>Monthly Salary</th><td>{{ selectedApplication.salary | currency:'INR' }}</td></tr>
                    <tr><th>Employment</th><td>{{ selectedApplication.employmentStatus }}</td></tr>
                    <tr><th>Credit Score</th><td><span [ngClass]="creditScoreClass(selectedApplication.creditScore)">{{ selectedApplication.creditScore || 'N/A' }}</span></td></tr>
                    <tr><th>Assets</th><td>{{ selectedApplication.assets || 'N/A' }}</td></tr>
                  </table>
                </div>
              </div>
            </div>
            <!-- Address -->
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-light fw-bold">üè† Address</div>
                <div class="card-body">
                  <p class="mb-0">
                    {{ selectedApplication.address }}, {{ selectedApplication.city }}, 
                    {{ selectedApplication.state }} - {{ selectedApplication.zipCode }}
                  </p>
                </div>
              </div>
            </div>
            <!-- Existing Loans -->
            @if (selectedApplication.loans?.length) {
              <div class="col-12">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light fw-bold">üè¶ Existing Loans</div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered">
                        <thead>
                          <tr>
                            <th>Bank</th>
                            <th>Loan Amount</th>
                            <th>EMI</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (loan of selectedApplication.loans; track loan) {
                            <tr>
                              <td>{{ loan.bankName }}</td>
                              <td>{{ loan.loanAmount | currency:'INR' }}</td>
                              <td>{{ loan.emi | currency:'INR' }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            }
            <!-- Status & Dates -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
                <div>
                  <span class="fw-bold me-2">Current Status:</span>
                  <span class="badge" [ngClass]="statusBadgeClass(selectedApplication.applicationStatus)">
                    <i [ngClass]="statusIconClass(selectedApplication.applicationStatus)"></i>
                    {{ selectedApplication.applicationStatus | uppercase }}
                  </span>
                </div>
                <div>
                  <span class="text-muted">Applied on:</span>
                  <span class="fw-semibold ms-1">{{ selectedApplication.createdAt | date:'medium' }}</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="onEdit(selectedApplication?._id)" data-bs-dismiss="modal">
          <i class="bi bi-pencil"></i> Edit Application
        </button>
      </div>
    </div>
  </div>
</div>